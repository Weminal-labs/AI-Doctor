<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat</title>
    <style>
        #response, #broadcast {
            white-space: pre-wrap;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            min-height: 100px;
        }
    </style>
</head>
<body>
    <h1>AI Chat</h1>
    <form id="prompt-form">
        <textarea id="prompt" rows="4" cols="50" placeholder="Enter your prompt here"></textarea>
        <br>
        <button type="submit">Send</button>
    </form>
    <div id="response"></div>

    <h2>Broadcast Message</h2>
    <form id="broadcast-form">
        <input type="text" id="broadcast-message" placeholder="Enter message to broadcast">
        <button type="submit">Broadcast</button>
    </form>
    <div id="broadcast"></div>

    <script>
        const wsForm = document.getElementById('prompt-form');
        const promptInput = document.getElementById('prompt');
        const responseDiv = document.getElementById('response');
        const broadcastForm = document.getElementById('broadcast-form');
        const broadcastInput = document.getElementById('broadcast-message');
        const broadcastDiv = document.getElementById('broadcast');

        let ws;

        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws`);
            
            ws.onopen = () => {
                console.log('WebSocket connection established');
            };

            ws.onmessage = (event) => {
                if (event.data === "[END]") {
                    console.log('Response complete');
                } else {
                    responseDiv.textContent += event.data;
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket connection closed');
                setTimeout(connectWebSocket, 1000);
            };
        }

        connectWebSocket();

        wsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const prompt = promptInput.value.trim();
            if (prompt && ws.readyState === WebSocket.OPEN) {
                responseDiv.textContent = '';
                ws.send(prompt);
                promptInput.value = '';
            }
        });

        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = broadcastInput.value.trim();
            if (message) {
                try {
                    const response = await fetch('/send_message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ content: message }),
                    });
                    if (response.ok) {
                        broadcastInput.value = '';
                        broadcastDiv.textContent += `Sent: ${message}\n`;
                    } else {
                        console.error('Failed to send message');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        });
    </script>
</body>
</html>